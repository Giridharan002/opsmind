
// Backend API URL - Deployed on Render
BACKEND_URL = "https://opsmind-backend.onrender.com";
// Parse command arguments - 'arguments' is the text after /ops
command = arguments.trim();
response = Map();
try 
{
	info "Command: " + command;
	// Handle different commands
	if(command == "status")
	{
		// Call /ops/status endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/status"
			type: GET
			detailed: false
			connection-timeout: 10000
		];
		info "API Response: " + api_response;
		summary = api_response.get("summary");
		health_score = api_response.get("health_score");
		status_text = "ğŸ“Š **Team Operations Status**\n\n";
		status_text = status_text + "âœ… Total Tasks: **" + summary.get("total_tasks") + "**\n";
		status_text = status_text + "âš ï¸ At Risk: **" + summary.get("at_risk") + "**\n";
		status_text = status_text + "â° Overdue: **" + summary.get("overdue") + "**\n";
		status_text = status_text + "ğŸ”¥ Incidents Today: **" + summary.get("incidents_today") + "**\n";
		status_text = status_text + "ğŸ“‰ Overloaded Members: **" + summary.get("overloaded_members") + "**\n\n";
		// Health score emoji
		health_emoji = "ğŸŸ¢";
		if(health_score < 70)
		{
			health_emoji = "ğŸŸ¡";
		}
		if(health_score < 50)
		{
			health_emoji = "ğŸ”´";
		}
		status_text = status_text + health_emoji + " **Health Score: " + health_score + "/100**";
		response.put("text",status_text);
	}
	else if(command == "risks")
	{
		// Call /ops/risks endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/risks"
			type: GET
			detailed: false
			connection-timeout: 10000
		];
		info "API Response: " + api_response;
		count = api_response.get("count");
		tasks = api_response.get("tasks");
		ai_analysis = api_response.get("ai_analysis");
		risks_text = "âš ï¸ **Tasks At Risk: " + count + "**\n\n";
		// Show top 3 at-risk tasks
		i = 0;
		for each  task in tasks
		{
			i = i + 1;
			title = task.get("title");
			if(title == null)
			{
				title = "Untitled";
			}
			owner = task.get("owner");
			if(owner == null)
			{
				owner = "Unassigned";
			}
			status = task.get("status");
			if(status == null)
			{
				status = "unknown";
			}
			priority = task.get("priority");
			if(priority == null)
			{
				priority = "0";
			}
			risks_text = risks_text + i + ". **" + title + "**\n";
			risks_text = risks_text + "   Owner: " + owner + "\n";
			risks_text = risks_text + "   Status: " + status + " | Priority: " + priority + "\n\n";
			if(i == 3)
			{
				break;
			}
		}
		// AI analysis summary - shortened for Cliq display
		analysis = ai_analysis.get("analysis");
		if(analysis == null)
		{
			analysis = "Analysis not available.";
		}
		else if(analysis.length() > 200)
		{
			analysis = analysis.subString(0,197) + "...";
		}
		risks_text = risks_text + "\nğŸ¤– **AI Analysis:**\n" + analysis;
		// Ensure text is not too long for Cliq
		if(risks_text.length() > 1000)
		{
			risks_text = risks_text.subString(0,997) + "...";
		}
		response.put("text",risks_text);
	}
	else if(command == "overload")
	{
		// Call /ops/overload endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/overload"
			type: GET
			detailed: false
			connection-timeout: 10000
		];
		info "API Response: " + api_response;
		count = api_response.get("count");
		users = api_response.get("users");
		overload_text = "ğŸ“‰ Overloaded Team Members: " + count + "\n\n";
		if(count == 0 || users == null || users.size() == 0)
		{
			overload_text = overload_text + "âœ… No team members are overloaded. Great work!";
		}
		else
		{
			for each  user_data in users
			{
				user_id = user_data.get("user_id");
				if(user_id == null)
				{
					user_id = "Unknown";
				}
				total_hours = user_data.get("total_hours");
				if(total_hours == null)
				{
					total_hours = "0";
				}
				else
				{
					total_hours = total_hours.toString();
				}
				total_meetings = user_data.get("total_meetings");
				if(total_meetings == null)
				{
					total_meetings = "0";
				}
				else
				{
					total_meetings = total_meetings.toString();
				}
				active_tasks = user_data.get("active_tasks");
				if(active_tasks == null)
				{
					active_tasks = "0";
				}
				else
				{
					active_tasks = active_tasks.toString();
				}
				overload_text = overload_text + "User: " + user_id + "\n";
				overload_text = overload_text + "Hours: " + total_hours + " | Meetings: " + total_meetings + " | Tasks: " + active_tasks + "\n\n";
			}
		}
		response.put("text",overload_text);
	}
	else if(command == "incidents")
	{
		// Call /ops/incidents endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/incidents"
			type: GET
			detailed: false
			connection-timeout: 10000
		];
		info "API Response: " + api_response;
		count = api_response.get("count");
		patterns = api_response.get("patterns");
		incidents_text = "ğŸ”¥ **Incidents (Last 24h): " + count + "**\n\n";
		if(patterns.size() > 0)
		{
			incidents_text = incidents_text + "ğŸ” **Detected Patterns:**\n";
			i = 0;
			for each  pattern in patterns
			{
				i = i + 1;
				incidents_text = incidents_text + i + ". " + pattern.get("summary") + " (occurred " + pattern.get("occurrence_count") + " times)\n";
			}
		}
		else
		{
			incidents_text = incidents_text + "âœ… No repeating patterns detected.";
		}
		response.put("text",incidents_text);
	}
	else if(command == "sprint-delay")
	{
		// Call /ops/sprint-delay endpoint (KILLER FEATURE)
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/sprint-delay"
			type: GET
			detailed: false
			connection-timeout: 15000
		];
		info "API Response: " + api_response;
		sprint_status = api_response.get("sprint_status");
		if(sprint_status == null)
		{
			sprint_status = "unknown";
		}
		overdue_count = api_response.get("overdue_count");
		if(overdue_count == null)
		{
			overdue_count = 0;
		}
		blocked_count = api_response.get("blocked_count");
		if(blocked_count == null)
		{
			blocked_count = 0;
		}
		incident_impact = api_response.get("incident_impact");
		if(incident_impact == null)
		{
			incident_impact = 0;
		}
		overloaded_members = api_response.get("overloaded_members");
		if(overloaded_members == null)
		{
			overloaded_members = 0;
		}
		root_cause_analysis = api_response.get("root_cause_analysis");
		delay_text = "ğŸš¨ **Sprint Status: " + sprint_status.toUpperCase() + "**\n\n";
		delay_text = delay_text + "ğŸ“Š **Metrics:**\n";
		delay_text = delay_text + "â° Overdue Tasks: " + overdue_count + "\n";
		delay_text = delay_text + "ğŸš« Blocked Tasks: " + blocked_count + "\n";
		delay_text = delay_text + "ğŸ”¥ Incident Impact: " + incident_impact + " incidents\n";
		delay_text = delay_text + "ğŸ“‰ Overloaded Members: " + overloaded_members + "\n\n";
		// Root cause
		root_cause = root_cause_analysis.get("root_cause");
		if(root_cause == null)
		{
			root_cause = "Unable to determine root cause.";
		}
		delay_text = delay_text + "ğŸ¯ **Root Cause:**\n" + root_cause + "\n\n";
		// Recommendations
		recommendations = api_response.get("recommendations");
		if(recommendations.size() > 0)
		{
			delay_text = delay_text + "ğŸ‘‰ **Recommended Actions:**\n";
			i = 0;
			for each  rec in recommendations
			{
				i = i + 1;
				// Check if rec is a map (has action key) or string
				rec_text = "";
				if(rec.containKey("action"))
				{
					rec_text = rec.get("action");
				}
				else
				{
					rec_text = rec.toString();
				}
				delay_text = delay_text + i + ". " + rec_text + "\n";
				if(i == 3)
				{
					break;
				}
			}
		}
		response.put("text",delay_text);
	}
	else
	{
		// Default help
		response.put("text","Use `/ops help` to see available commands.");
	}
	return response;
}
catch (e)
{
	info e;
	response.put("text","âš ï¸ Error connecting to OpsMind backend. Please check your configuration.");
	return response;
}
return response;
