// Backend API URL - Deployed on Render
BACKEND_URL = "https://opsmind-backend.onrender.com";

response = Map();

try 
{
	// Parse command arguments
	command = arguments.get("command");
	info "Command: " + command;
	
	bot = Map();
	bot.put("name","OpsMind");
	bot.put("image","https://i.imgur.com/OpsMind.png");
	response.put("bot",bot);
	
	card = Map();
	card.put("theme","modern-inline");
	response.put("card",card);
	
	// Handle different commands
	if(command == "status")
	{
		// Call /ops/status endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/status"
			type: GET
		];
		info api_response;
		
		summary = api_response.get("summary");
		health_score = api_response.get("health_score");
		
		status_text = "ğŸ“Š **Team Operations Status**\n\n";
		status_text = status_text + "âœ… Total Tasks: **" + summary.get("total_tasks") + "**\n";
		status_text = status_text + "âš ï¸ At Risk: **" + summary.get("at_risk") + "**\n";
		status_text = status_text + "â° Overdue: **" + summary.get("overdue") + "**\n";
		status_text = status_text + "ğŸ”¥ Incidents Today: **" + summary.get("incidents_today") + "**\n";
		status_text = status_text + "ğŸ“‰ Overloaded Members: **" + summary.get("overloaded_members") + "**\n\n";
		
		// Health score emoji
		health_emoji = "ğŸŸ¢";
		if(health_score < 70)
		{
			health_emoji = "ğŸŸ¡";
		}
		if(health_score < 50)
		{
			health_emoji = "ğŸ”´";
		}
		status_text = status_text + health_emoji + " **Health Score: " + health_score + "/100**";
		
		response.put("text",status_text);
	}
	else if(command == "risks")
	{
		// Call /ops/risks endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/risks"
			type: GET
		];
		info api_response;
		
		count = api_response.get("count");
		tasks = api_response.get("tasks");
		ai_analysis = api_response.get("ai_analysis");
		
		risks_text = "âš ï¸ **Tasks At Risk: " + count + "**\n\n";
		
		// Show top 3 at-risk tasks
		i = 0;
		for each task in tasks
		{
			i = i + 1;
			risks_text = risks_text + i + ". **" + task.get("title") + "**\n";
			risks_text = risks_text + "   Owner: " + task.get("owner") + "\n";
			risks_text = risks_text + "   Status: " + task.get("status") + " | Priority: " + task.get("priority") + "\n\n";
			
			if(i == 3)
			{
				break;
			}
		}
		
		// AI analysis summary
		analysis = ai_analysis.get("analysis");
		if(analysis.length() > 300)
		{
			analysis = analysis.subString(0,297) + "...";
		}
		risks_text = risks_text + "\nğŸ¤– **AI Analysis:**\n" + analysis;
		
		response.put("text",risks_text);
	}
	else if(command == "overload")
	{
		// Call /ops/overload endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/overload"
			type: GET
		];
		info api_response;
		
		count = api_response.get("count");
		users = api_response.get("users");
		
		overload_text = "ğŸ“‰ **Overloaded Team Members: " + count + "**\n\n";
		
		if(count == 0)
		{
			overload_text = overload_text + "âœ… No team members are overloaded. Great work! ğŸ‰";
		}
		else
		{
			for each user_data in users
			{
				overload_text = overload_text + "ğŸ‘¤ **" + user_data.get("user_id") + "**\n";
				overload_text = overload_text + "   â±ï¸ Total Hours: " + user_data.get("total_hours") + "\n";
				overload_text = overload_text + "   ğŸ—“ï¸ Meetings: " + user_data.get("total_meetings") + "\n";
				overload_text = overload_text + "   ğŸ”¢ Active Tasks: " + user_data.get("active_tasks") + "\n\n";
			}
		}
		
		response.put("text",overload_text);
	}
	else if(command == "incidents")
	{
		// Call /ops/incidents endpoint
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/incidents"
			type: GET
		];
		info api_response;
		
		count = api_response.get("count");
		patterns = api_response.get("patterns");
		
		incidents_text = "ğŸ”¥ **Incidents (Last 24h): " + count + "**\n\n";
		
		if(patterns.size() > 0)
		{
			incidents_text = incidents_text + "ğŸ” **Detected Patterns:**\n";
			i = 0;
			for each pattern in patterns
			{
				i = i + 1;
				incidents_text = incidents_text + i + ". " + pattern.get("summary") + " (occurred " + pattern.get("occurrence_count") + " times)\n";
			}
		}
		else
		{
			incidents_text = incidents_text + "âœ… No repeating patterns detected.";
		}
		
		response.put("text",incidents_text);
	}
	else if(command == "sprint-delay")
	{
		// Call /ops/sprint-delay endpoint (KILLER FEATURE)
		api_response = invokeurl
		[
			url: BACKEND_URL + "/ops/sprint-delay"
			type: GET
		];
		info api_response;
		
		sprint_status = api_response.get("sprint_status");
		overdue_count = api_response.get("overdue_count");
		blocked_count = api_response.get("blocked_count");
		incident_impact = api_response.get("incident_impact");
		overloaded_members = api_response.get("overloaded_members");
		root_cause_analysis = api_response.get("root_cause_analysis");
		
		delay_text = "ğŸš¨ **Sprint Status: " + sprint_status.toUpperCase() + "**\n\n";
		delay_text = delay_text + "ğŸ“Š **Metrics:**\n";
		delay_text = delay_text + "â° Overdue Tasks: " + overdue_count + "\n";
		delay_text = delay_text + "ğŸš« Blocked Tasks: " + blocked_count + "\n";
		delay_text = delay_text + "ğŸ”¥ Incident Impact: " + incident_impact + " incidents\n";
		delay_text = delay_text + "ğŸ“‰ Overloaded Members: " + overloaded_members + "\n\n";
		
		// Root cause
		root_cause = root_cause_analysis.get("root_cause");
		delay_text = delay_text + "ğŸ¯ **Root Cause:**\n" + root_cause + "\n\n";
		
		// Recommendations
		recommendations = api_response.get("recommendations");
		if(recommendations.size() > 0)
		{
			delay_text = delay_text + "ğŸ‘‰ **Recommended Actions:**\n";
			i = 0;
			for each rec in recommendations
			{
				i = i + 1;
				if(rec.typeOf() == "STRING")
				{
					delay_text = delay_text + i + ". " + rec + "\n";
				}
				else if(rec.get("action") != null)
				{
					delay_text = delay_text + i + ". " + rec.get("action") + "\n";
				}
				
				if(i == 3)
				{
					break;
				}
			}
		}
		
		response.put("text",delay_text);
	}
	else
	{
		// Default help
		response.put("text","Use `/ops help` to see available commands.");
	}
	
	return response;
}
catch (e)
{
	info e;
	response.put("text","âš ï¸ Error connecting to OpsMind backend. Please check your configuration.");
	return response;
}
